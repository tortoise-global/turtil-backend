name: Deploy Turtil Backend

on:
  push:
    branches:
      - dev
  workflow_dispatch:

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'ap-south-1' }}
  ENVIRONMENT: 'dev'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: dev
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Setup Packer
      uses: hashicorp/setup-packer@main
      with:
        version: 'latest'

    - name: Create environment file for Packer
      run: |
        cd turtil-backend/packer
        cat > build.env << EOF
        # Application Configuration
        PROJECT_NAME=${{ vars.PROJECT_NAME || 'turtil-backend' }}
        VERSION=${{ vars.VERSION || '1.0.0' }}
        ENVIRONMENT=${{ env.ENVIRONMENT }}
        DEBUG=${{ vars.DEBUG || 'false' }}
        LOG_LEVEL=${{ vars.LOG_LEVEL || 'INFO' }}
        PORT=${{ vars.PORT || '8000' }}
        
        # Database Configuration
        DATABASE_URL=${{ secrets.DATABASE_URL }}
        
        # Security Configuration
        SECRET_KEY=${{ secrets.SECRET_KEY }}
        ALGORITHM=${{ vars.ALGORITHM || 'HS256' }}
        CMS_ACCESS_TOKEN_EXPIRE_MINUTES=${{ vars.CMS_ACCESS_TOKEN_EXPIRE_MINUTES || '30' }}
        CMS_REFRESH_TOKEN_EXPIRE_DAYS=${{ vars.CMS_REFRESH_TOKEN_EXPIRE_DAYS || '30' }}
        
        # CORS and Host Configuration
        CORS_ORIGINS=${{ vars.CORS_ORIGINS || 'https://app.turtil.co,https://turtil.co' }}
        ALLOWED_HOSTS=${{ vars.ALLOWED_HOSTS || '*' }}
        
        # Rate Limiting Configuration
        RATE_LIMIT_CALLS=${{ vars.RATE_LIMIT_CALLS || '100' }}
        RATE_LIMIT_PERIOD=${{ vars.RATE_LIMIT_PERIOD || '60' }}
        
        # OTP Configuration
        DEV_OTP=${{ vars.DEV_OTP || 'disabled' }}
        
        # Upstash Redis Configuration
        UPSTASH_REDIS_URL=${{ secrets.UPSTASH_REDIS_URL }}
        UPSTASH_REDIS_TOKEN=${{ secrets.UPSTASH_REDIS_TOKEN }}
        REDIS_BLACKLIST_TTL=${{ vars.REDIS_BLACKLIST_TTL || '86400' }}
        
        # AWS Configuration
        AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_REGION=${{ env.AWS_REGION }}
        AWS_SES_FROM_EMAIL=${{ vars.AWS_SES_FROM_EMAIL || 'support@turtil.co' }}
        AWS_SES_REGION=${{ vars.AWS_SES_REGION || 'ap-south-1' }}
        
        # S3 Configuration
        S3_BUCKET_NAME=${{ vars.S3_BUCKET_NAME || 'turtil-backend-dev' }}
        EOF

    - name: Initialize Packer
      run: |
        cd turtil-backend/packer
        packer init .

    - name: Validate Packer template
      run: |
        cd turtil-backend/packer
        packer validate \
          -var "aws_region=${{ env.AWS_REGION }}" \
          -var "environment=${{ env.ENVIRONMENT }}" \
          -var "instance_type=t4g.small" \
          -var "source_ami=ami-0f4448044b7b1e09b" \
          amazon-linux.pkr.hcl

    - name: Build AMI with Packer
      id: packer-build
      run: |
        cd turtil-backend/packer
        # Build AMI and capture the output
        packer build \
          -var "aws_region=${{ env.AWS_REGION }}" \
          -var "environment=${{ env.ENVIRONMENT }}" \
          -var "instance_type=t4g.small" \
          -var "source_ami=ami-0f4448044b7b1e09b" \
          -machine-readable \
          amazon-linux.pkr.hcl | tee packer-output.log
        
        # Extract AMI ID from Packer output
        AMI_ID=$(grep 'artifact,0,id' packer-output.log | cut -d, -f6 | cut -d: -f2)
        echo "AMI_ID=$AMI_ID" >> $GITHUB_OUTPUT
        echo "New AMI created: $AMI_ID"

    - name: Update Launch Template
      env:
        AMI_ID: ${{ steps.packer-build.outputs.AMI_ID }}
        LAUNCH_TEMPLATE_ID: ${{ secrets.LAUNCH_TEMPLATE_ID }}
      run: |
        echo "Updating Launch Template $LAUNCH_TEMPLATE_ID with new AMI $AMI_ID"
        
        # Create new launch template version
        NEW_VERSION=$(aws ec2 create-launch-template-version \
          --launch-template-id $LAUNCH_TEMPLATE_ID \
          --source-version '$Latest' \
          --launch-template-data "{\"ImageId\":\"$AMI_ID\"}" \
          --query 'LaunchTemplateVersion.VersionNumber' \
          --output text)
        
        echo "Created new launch template version: $NEW_VERSION"
        
        # Set new version as default
        aws ec2 modify-launch-template \
          --launch-template-id $LAUNCH_TEMPLATE_ID \
          --default-version $NEW_VERSION
        
        echo "Set version $NEW_VERSION as default"

    - name: Create environment file for instances
      run: |
        # Create user data script with environment variables
        cat > user-data.sh << 'EOF'
        #!/bin/bash
        
        # Create environment file for the application
        mkdir -p /home/ec2-user/.env
        cat > /home/ec2-user/.env/production.env << 'INNER_EOF'
        PROJECT_NAME=${{ vars.PROJECT_NAME || 'turtil-backend' }}
        VERSION=${{ vars.VERSION || '1.0.0' }}
        ENVIRONMENT=${{ env.ENVIRONMENT }}
        DEBUG=${{ vars.DEBUG || 'false' }}
        LOG_LEVEL=${{ vars.LOG_LEVEL || 'INFO' }}
        PORT=${{ vars.PORT || '8000' }}
        DATABASE_URL=${{ secrets.DATABASE_URL }}
        SECRET_KEY=${{ secrets.SECRET_KEY }}
        ALGORITHM=${{ vars.ALGORITHM || 'HS256' }}
        CMS_ACCESS_TOKEN_EXPIRE_MINUTES=${{ vars.CMS_ACCESS_TOKEN_EXPIRE_MINUTES || '30' }}
        CMS_REFRESH_TOKEN_EXPIRE_DAYS=${{ vars.CMS_REFRESH_TOKEN_EXPIRE_DAYS || '30' }}
        CORS_ORIGINS=${{ vars.CORS_ORIGINS || 'https://app.turtil.co,https://turtil.co' }}
        ALLOWED_HOSTS=${{ vars.ALLOWED_HOSTS || '*' }}
        RATE_LIMIT_CALLS=${{ vars.RATE_LIMIT_CALLS || '100' }}
        RATE_LIMIT_PERIOD=${{ vars.RATE_LIMIT_PERIOD || '60' }}
        DEV_OTP=${{ vars.DEV_OTP || 'disabled' }}
        UPSTASH_REDIS_URL=${{ secrets.UPSTASH_REDIS_URL }}
        UPSTASH_REDIS_TOKEN=${{ secrets.UPSTASH_REDIS_TOKEN }}
        REDIS_BLACKLIST_TTL=${{ vars.REDIS_BLACKLIST_TTL || '86400' }}
        AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_REGION=${{ env.AWS_REGION }}
        AWS_SES_FROM_EMAIL=${{ vars.AWS_SES_FROM_EMAIL || 'support@turtil.co' }}
        AWS_SES_REGION=${{ vars.AWS_SES_REGION || 'ap-south-1' }}
        S3_BUCKET_NAME=${{ vars.S3_BUCKET_NAME || 'turtil-backend-dev' }}
        INNER_EOF
        
        # Set proper ownership
        chown -R ec2-user:ec2-user /home/ec2-user/.env
        
        # Start the application service
        systemctl start turtil-backend.service
        EOF
        
        # Encode user data as base64
        USER_DATA_B64=$(base64 -w 0 user-data.sh)
        echo "USER_DATA_B64=$USER_DATA_B64" >> $GITHUB_ENV

    - name: Trigger Auto Scaling Group Instance Refresh
      env:
        AUTO_SCALING_GROUP_NAME: ${{ secrets.AUTO_SCALING_GROUP_NAME }}
      run: |
        echo "Starting instance refresh for Auto Scaling Group: $AUTO_SCALING_GROUP_NAME"
        
        # Start instance refresh
        INSTANCE_REFRESH_ID=$(aws autoscaling start-instance-refresh \
          --auto-scaling-group-name $AUTO_SCALING_GROUP_NAME \
          --preferences '{
            "InstanceWarmup": 300,
            "MinHealthyPercentage": 50,
            "CheckpointPercentages": [50, 100],
            "CheckpointDelay": 600
          }' \
          --query 'InstanceRefreshId' \
          --output text)
        
        echo "Instance refresh started with ID: $INSTANCE_REFRESH_ID"
        
        # Wait for instance refresh to complete
        echo "Waiting for instance refresh to complete..."
        aws autoscaling wait instance-refresh-successful \
          --auto-scaling-group-name $AUTO_SCALING_GROUP_NAME \
          --instance-refresh-ids $INSTANCE_REFRESH_ID
        
        echo "Instance refresh completed successfully!"

    - name: Verify Deployment
      env:
        AUTO_SCALING_GROUP_NAME: ${{ secrets.AUTO_SCALING_GROUP_NAME }}
        LOAD_BALANCER_DNS: ${{ secrets.LOAD_BALANCER_DNS }}
      run: |
        echo "Verifying deployment..."
        
        # Check Auto Scaling Group instances
        aws autoscaling describe-auto-scaling-groups \
          --auto-scaling-group-names $AUTO_SCALING_GROUP_NAME \
          --query 'AutoScalingGroups[0].Instances[*].[InstanceId,LifecycleState,HealthStatus]' \
          --output table
        
        # Wait for load balancer health checks
        echo "Waiting for load balancer health checks..."
        sleep 120
        
        # Test application health endpoint
        if [ -n "$LOAD_BALANCER_DNS" ]; then
          for i in {1..10}; do
            if curl -f "http://$LOAD_BALANCER_DNS/health" >/dev/null 2>&1; then
              echo "✅ Application is healthy and accessible via load balancer"
              exit 0
            fi
            echo "Waiting for application to be healthy... ($i/10)"
            sleep 30
          done
          echo "❌ Application health check failed"
          exit 1
        else
          echo "⚠️ Load balancer DNS not configured in secrets, skipping health check"
        fi

    - name: Cleanup old AMIs
      run: |
        echo "Cleaning up old AMIs..."
        
        # Get list of AMIs for this environment (keeping last 5)
        aws ec2 describe-images \
          --owners self \
          --filters "Name=name,Values=turtil-backend-${{ env.ENVIRONMENT }}-*" \
          --query 'sort_by(Images, &CreationDate)[:-5].[ImageId,Name]' \
          --output text | while read ami_id name; do
          if [ -n "$ami_id" ] && [ "$ami_id" != "None" ]; then
            echo "Deregistering old AMI: $ami_id ($name)"
            aws ec2 deregister-image --image-id $ami_id || true
          fi
        done
        
        echo "AMI cleanup completed"

    - name: Deployment Summary
      env:
        AMI_ID: ${{ steps.packer-build.outputs.AMI_ID }}
      run: |
        echo "🚀 Deployment Summary"
        echo "===================="
        echo "Environment: ${{ env.ENVIRONMENT }}"
        echo "New AMI ID: $AMI_ID"
        echo "AWS Region: ${{ env.AWS_REGION }}"
        echo "Timestamp: $(date)"
        echo "Commit SHA: ${{ github.sha }}"
        echo "===================="